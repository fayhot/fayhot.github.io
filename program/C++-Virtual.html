<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="alternate" href="/atom.xml" title="Fayhot's Blog" type="application/atom+xml">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-pace-theme-center-atom.min.css">
  <script src="/lib/pace/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://fayhot.github.io').hostname,
    root: '/',
    scheme: 'Muse',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: true,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="C++ Virtual  Virtual Function  whatâ€™s virtual  The virtual specifier specifies that a non-static member function is virtual and supports dynamic dispatch. It may only appear in the decl-specifier-seq">
<meta name="keywords" content="C++">
<meta property="og:type" content="article">
<meta property="og:title" content="C++ Virtual(è™šå‡½æ•°)">
<meta property="og:url" content="http:&#x2F;&#x2F;fayhot.github.io&#x2F;program&#x2F;C++-Virtual.html">
<meta property="og:site_name" content="Fayhot&#39;s Blog">
<meta property="og:description" content="C++ Virtual  Virtual Function  whatâ€™s virtual  The virtual specifier specifies that a non-static member function is virtual and supports dynamic dispatch. It may only appear in the decl-specifier-seq">
<meta property="og:locale" content="en">
<meta property="og:image" content="http:&#x2F;&#x2F;fayhot.github.io&#x2F;assets&#x2F;2019&#x2F;12&#x2F;09&#x2F;vtables.png">
<meta property="og:image" content="http:&#x2F;&#x2F;fayhot.github.io&#x2F;assets&#x2F;2019&#x2F;12&#x2F;09&#x2F;vpointer.png">
<meta property="og:image" content="http:&#x2F;&#x2F;fayhot.github.io&#x2F;assets&#x2F;2019&#x2F;12&#x2F;09&#x2F;vtable_exmple.png">
<meta property="og:image" content="http:&#x2F;&#x2F;fayhot.github.io&#x2F;assets&#x2F;2019&#x2F;12&#x2F;09&#x2F;virtual_inherit_common.png">
<meta property="og:image" content="http:&#x2F;&#x2F;fayhot.github.io&#x2F;assets&#x2F;2019&#x2F;12&#x2F;09&#x2F;vtable_example2.png">
<meta property="og:image" content="http:&#x2F;&#x2F;fayhot.github.io&#x2F;assets&#x2F;2019&#x2F;12&#x2F;09&#x2F;virtual_inherit_common.png">
<meta property="og:image" content="http:&#x2F;&#x2F;fayhot.github.io&#x2F;assets&#x2F;2019&#x2F;12&#x2F;09&#x2F;vtable_example3.png">
<meta property="og:image" content="http:&#x2F;&#x2F;fayhot.github.io&#x2F;assets&#x2F;2019&#x2F;12&#x2F;09&#x2F;virtual_inherit_multi.png">
<meta property="og:image" content="http:&#x2F;&#x2F;fayhot.github.io&#x2F;assets&#x2F;2019&#x2F;12&#x2F;09&#x2F;vtable_example4.png">
<meta property="og:image" content="http:&#x2F;&#x2F;fayhot.github.io&#x2F;assets&#x2F;2019&#x2F;12&#x2F;09&#x2F;virtual_inherit_multi.png">
<meta property="og:image" content="http:&#x2F;&#x2F;fayhot.github.io&#x2F;assets&#x2F;2019&#x2F;12&#x2F;09&#x2F;vtable_example5.png">
<meta property="og:updated_time" content="2019-12-19T02:53:32.847Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;fayhot.github.io&#x2F;assets&#x2F;2019&#x2F;12&#x2F;09&#x2F;vtables.png">

<link rel="canonical" href="http://fayhot.github.io/program/C++-Virtual.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>C++ Virtual(è™šå‡½æ•°) | Fayhot's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Fayhot's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="Searching..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="http://fayhot.github.io/program/C++-Virtual.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Fayhot">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fayhot's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          C++ Virtual(è™šå‡½æ•°)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-10 14:25:36" itemprop="dateCreated datePublished" datetime="2017-07-10T14:25:36+08:00">2017-07-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-12-19 10:53:32" itemprop="dateModified" datetime="2019-12-19T10:53:32+08:00">2019-12-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index">
                    <span itemprop="name">ç¼–ç¨‹</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="c-virtual"><a class="markdownIt-Anchor" href="#c-virtual"></a> C++ Virtual</h2>
<h3 id="virtual-function"><a class="markdownIt-Anchor" href="#virtual-function"></a> Virtual Function</h3>
<h4 id="whats-virtual"><a class="markdownIt-Anchor" href="#whats-virtual"></a> whatâ€™s virtual</h4>
<blockquote>
<p>The virtual specifier specifies that a non-static member function is virtual and supports dynamic dispatch. It may only appear in the decl-specifier-seq of the initial declaration of a non-static member function (i.e., when it is declared in the class definition).</p>
</blockquote>
<h4 id="explanation"><a class="markdownIt-Anchor" href="#explanation"></a> Explanation</h4>
<p>Virtual functions are member functions whose behavior can be overridden in derived classes. As opposed to non-virtual functions, the overridden behavior is preserved even if there is no compile-time information about the actual type of the class. If a derived class is handled using pointer or reference to the base class, a call to an overridden virtual function would invoke the behavior defined in the derived class. This behavior is suppressed if the function is selected using qualified name lookup (that is, if the functionâ€™s name appears to the right of the scope resolution operator :ğŸ˜ƒ.</p>
<a id="more"></a>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Base</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">       <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"base\n"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">   &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Derived</span> :</span> Base &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> override </span>&#123; <span class="comment">// 'override' is optional</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"derived\n"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    Base b;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    Derived d;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// virtual function call through reference</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    Base&amp; br = b; <span class="comment">// the type of br is Base&amp;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    Base&amp; dr = d; <span class="comment">// the type of dr is Base&amp; as  well</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    br.f(); <span class="comment">// prints "base"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    dr.f(); <span class="comment">// prints "derived"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// virtual function call through pointer</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    Base* bp = &amp;b; <span class="comment">// the type of bp is Base*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    Base* dp = &amp;d; <span class="comment">// the type of dp is Base* as  well</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    bp-&gt;f(); <span class="comment">// prints "base"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    dp-&gt;f(); <span class="comment">// prints "derived"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// non-virtual function call</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    br.Base::f(); <span class="comment">// prints "base"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    dr.Base::f(); <span class="comment">// prints "base"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>C++ä¸­ä½¿ç”¨ classname::functionname å¯ä»¥ç›´æ¥è·å–æˆå‘˜å‡½æ•°çš„åœ°å€æŒ‡é’ˆ</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// non-virtual function call</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">br.Base::f(); <span class="comment">// prints "base"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">dr.Base::f(); <span class="comment">// prints "base"</span></span></pre></td></tr></table></figure>
<p>ä¸æ”¯æŒå¤šé‡ç»§æ‰¿çš„è¯­è¨€ä¸éœ€è¦æä¾›virtualè¯æ³•ï¼Œå†…éƒ¨æä¾›äº†ç±»ä¼¼virtualçš„æœºåˆ¶ï¼Œä¸”é»˜è®¤ä½¿ç”¨</p>
<h4 id="another-example-why-virtual-required"><a class="markdownIt-Anchor" href="#another-example-why-virtual-required"></a> another example (why virtual required)</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="class">&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"I'm eating generic food."</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span> :</span> <span class="keyword">public</span> Animal</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"I'm eating a rat."</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr></table></figure>
<p>In your main function:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Animal *animal = <span class="keyword">new</span> Animal;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">Cat *cat = <span class="keyword">new</span> Cat;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">animal-&gt;eat(); <span class="comment">// Outputs: "I'm eating generic food."</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">cat-&gt;eat();    <span class="comment">// Outputs: "I'm eating a rat."</span></span></pre></td></tr></table></figure>
<p>So far so good, right? Animals eat generic food, cats eat rats, all without virtual.</p>
<p>Letâ€™s change it a little now so that eat() is called via an intermediate function (a trivial function just for this example):</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// This can go at the top of the main.cpp file</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(Animal *xyz)</span> </span>&#123; xyz-&gt;eat(); &#125;</span></pre></td></tr></table></figure>
<p>Now our main function is:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Animal *animal = <span class="keyword">new</span> Animal;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">Cat *cat = <span class="keyword">new</span> Cat;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">func(animal); <span class="comment">// Outputs: "I'm eating generic food."</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">func(cat);    <span class="comment">// Outputs: "I'm eating generic food."</span></span></pre></td></tr></table></figure>
<p>Uh ohâ€¦ we passed a Cat into func(), but it wonâ€™t eat rats. Should you overload func() so it takes a Cat*? If you have to derive more animals from Animal they would all need their own func().</p>
<p>The solution is to make eat() from the Animal class a virtual function:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="class">&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"I'm eating generic food."</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span> :</span> <span class="keyword">public</span> Animal</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"I'm eating a rat."</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr></table></figure>
<p>Main:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">func(animal); <span class="comment">// Outputs: "I'm eating generic food."</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">func(cat);    <span class="comment">// Outputs: "I'm eating a rat."</span></span></pre></td></tr></table></figure>
<h3 id="in-detail"><a class="markdownIt-Anchor" href="#in-detail"></a> In detail</h3>
<p>If some member function vf is declared as virtual in a class Base, and some class Derived, which is derived, directly or indirectly, from Base, has a declaration for member function with the same</p>
<ul>
<li>name</li>
<li>parameter type list (but not the return type)</li>
<li>cv-qualifiers</li>
<li>ref-qualifiers</li>
</ul>
<p>Then this function in the class Derived is also virtual (whether or not the keyword virtual is used in its declaration) and overrides Base::vf (whether or not the word override is used in its declaration).</p>
<p>Base::vf does not need to be visible (can be declared private, or inherited using private inheritance) to be overridden.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="class">&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">do_f</span><span class="params">()</span></span>; <span class="comment">// private member</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; do_f(); &#125; <span class="comment">// public interface</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">D</span> :</span> <span class="keyword">public</span> B </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">do_f</span><span class="params">()</span> override</span>; <span class="comment">// overrides B::do_f</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    D d;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    B* bp = &amp;d;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    bp-&gt;f(); <span class="comment">// internally calls D::do_f();</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>For every virtual function, there is the final overrider, which is executed when a virtual function call is made. A virtual member function vf of a base class Base is the final overrider unless the derived class declares or inherits (through multiple inheritance) another function that overrides vf.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A</span> &#123;</span> <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>; &#125;;     <span class="comment">// A::f is virtual</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">B</span> :</span> A &#123; <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>; &#125;;         <span class="comment">// B::f overrides A::f in B</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">C</span> :</span> <span class="keyword">virtual</span> B &#123; <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>; &#125;; <span class="comment">// C::f overrides A::f in C</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">D</span> :</span> <span class="keyword">virtual</span> B &#123;&#125;; <span class="comment">// D does not introduce an overrider, B::f is final in D</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">E</span> :</span> C, D  &#123;       <span class="comment">// E does not introduce an overrider, C::f is final in E</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">using</span> A::f; <span class="comment">// not a function declaration, just makes A::f visible to lookup</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">   E e;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">   e.f();    <span class="comment">// virtual call calls C::f, the final overrider in e</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">   e.E::f(); <span class="comment">// non-virtual call calls A::f, which is visible in E</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p><strong>A function with the same name but different parameter list does not override the base function of the same name, but hides it</strong>: when unqualified name lookup examines the scope of the derived class, the lookup finds the declaration and does not examine the base class.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">B</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">D</span> :</span> B &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span>)</span></span>; <span class="comment">// D::f hides B::f (wrong parameter list)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">D2</span> :</span> D &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>; <span class="comment">// D2::f overrides B::f (doesn't matter that it's not visible)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    B b;   B&amp; b_as_b   = b;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    D d;   B&amp; d_as_b   = d;    D&amp; d_as_d = d;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    D2 d2; B&amp; d2_as_b  = d2;   D&amp; d2_as_d = d2;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    b_as_b.f(); <span class="comment">// calls B::f()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    d_as_b.f(); <span class="comment">// calls B::f()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    d2_as_b.f(); <span class="comment">// calls D2::f()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    d_as_d.f(); <span class="comment">// Error: lookup in D finds only f(int)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    d2_as_d.f(); <span class="comment">// Error: lookup in D finds only f(int)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>If a function is declared with the specifier override, but does not override a virtual function, the program is ill-formed:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">B</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">D</span> :</span> B &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span>)</span> override</span>; <span class="comment">// OK, D::f(int) overrides B::f(int)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">long</span>)</span> override</span>; <span class="comment">// Error: f(long) does not override B::f(int)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr></table></figure>
<h4 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> <strong>æ€»ç»“ï¼š</strong></h4>
<ul>
<li><strong>Non-virtual method â‡’ static binding</strong></li>
<li><strong>virtual method =&gt; dynamic runtime binding</strong></li>
<li><strong>Non-member functions and static member functions cannot be virtual.</strong></li>
<li>è‹¥åŸºç±»ä¸­çš„æˆå‘˜å‡½æ•°å£°æ˜ä¸ºè™šå‡½æ•°ï¼Œæ´¾ç”Ÿç±»ä¸­é‡å†™çš„virtualå‡½æ•°è‡ªåŠ¨æˆä¸ºè™šå‡½æ•°</li>
</ul>
<h3 id="covariant-return-types"><a class="markdownIt-Anchor" href="#covariant-return-types"></a> Covariant return types</h3>
<p>If the function Derived::f overrides a function Base::f, their return types must either be the same or be covariant. Two types are covariant if they satisfy all of the following requirements:</p>
<ul>
<li>both types are pointers or references (lvalue or rvalue) to classes. Multi-level pointers or references are not allowed.</li>
<li>the referenced/pointed-to class in the return type of Base::f() must be a unambiguous and accessible direct or indirect base class of the referenced/pointed-to class of the return type of Derived::f().</li>
<li>the return type of Derived::f() must be equally or less cv-qualified than the return type of Base::f().</li>
</ul>
<p>The class in the return type of Derived::f must be either Derived itself, or must be a complete type at the point of declaration of Derived::f.</p>
<p>When a virtual function call is made, the type returned by the final overrider is implicitly converted to the return type of the overridden function that was called:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &#123;</span>&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Base</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">vf1</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">vf2</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">vf3</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">virtual</span> B* <span class="title">vf4</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">virtual</span> B* <span class="title">vf5</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> :</span> <span class="keyword">private</span> B &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">struct</span> <span class="title">Derived</span>;</span> <span class="comment">// in Derived, B is an accessible base of D</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>;</span> <span class="comment">// forward-declared class is an incomplete type</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Derived</span> :</span> <span class="keyword">public</span> Base &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">vf1</span><span class="params">()</span></span>;    <span class="comment">// virtual, overrides Base::vf1()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">vf2</span><span class="params">(<span class="keyword">int</span>)</span></span>; <span class="comment">// non-virtual, hides Base::vf2()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//  char vf3();    // Error: overrides Base::vf3, but has different</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">                   <span class="comment">// and non-covariant return type</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    <span class="function">D* <span class="title">vf4</span><span class="params">()</span></span>;      <span class="comment">// overrides Base::vf4() and has covariant return type</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//  A* vf5();      // Error: A is incomplete type</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    Derived d;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    Base&amp; br = d;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    Derived&amp; dr = d;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    br.vf1(); <span class="comment">// calls Derived::vf1()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    br.vf2(); <span class="comment">// calls Base::vf2()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//  dr.vf2(); // Error: vf2(int) hides vf2()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">    B* p = br.vf4(); <span class="comment">// calls Derived::vf4() and converts the result to B*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">    D* q = dr.vf4(); <span class="comment">// calls Derived::vf4() and does not convert</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">                     <span class="comment">//  the result to B*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<h3 id="virtual-destructor"><a class="markdownIt-Anchor" href="#virtual-destructor"></a> Virtual destructor</h3>
<p>çˆ¶ç±»æœ‰virtualä¿®é¥°çš„æ–¹æ³•ï¼Œä¸”è¢«å­ç±»è¦†ç›–ï¼Œéœ€è¦æ³¨æ„å¿…é¡»ä½¿ç”¨virtualå£°æ˜çˆ¶ç±»çš„ææ„å‡½æ•°ã€‚</p>
<blockquote>
<p>ä¸Šè¿°åœºæ™¯ä¸€èˆ¬ä½¿ç”¨å·¥å‚è®¾è®¡æ¨¡å¼ï¼Œå®šä¹‰ä¸€ä¸ªçˆ¶ç±»çš„æŒ‡é’ˆï¼ŒæŒ‡å‘å­ç±»å¯¹è±¡ï¼Œè€Œåœ¨delete çˆ¶ç±»æŒ‡é’ˆæ—¶ï¼ŒæœŸæœ›é‡Šæ”¾å¯¹è±¡ã€‚ä½†çˆ¶ç±»ææ„å‡½æ•°ä¸åŠ Virtualä¿®é¥°ï¼Œåˆ™åªä¼šè°ƒç”¨çˆ¶ç±»ææ„å‡½æ•°ï¼Œè€Œä¸è°ƒç”¨å­ç±»ææ„å‡½æ•°ï¼Œå¯¼è‡´åªé‡Šæ”¾äº†å¯¹è±¡çš„çˆ¶ç±»éƒ¨åˆ†ï¼Œè€Œå­ç±»éƒ¨åˆ†æ²¡æœ‰é‡Šæ”¾ã€‚Virtualå«ä¹‰å°±æ˜¯æœ‰ä¸€ä¸ªå‡½æ•°æ˜ å°„è¡¨ï¼Œè°ƒç”¨æ—¶ä¼šå»æŸ¥æ˜ å°„è¡¨è°ƒç”¨å¯¹åº”çš„æ–¹æ³•ã€‚</p>
</blockquote>
<p>Even though destructors are not inherited, if a base class declares its destructor virtual, the derived destructor always overrides it. This makes it possible to delete dynamically allocated objects of polymorphic type through pointers to base.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">virtual</span> ~Base() &#123; <span class="comment">/* releases Base's resources */</span> &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Derived</span> :</span> <span class="keyword">public</span> Base &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    ~Derived() &#123; <span class="comment">/* releases Derived's resources */</span> &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    Base* b = <span class="keyword">new</span> Derived;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">delete</span> b; <span class="comment">// Makes a virtual function call to Base::~Base()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">              <span class="comment">// since it is virtual, it calls Derived::~Derived() which can</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">              <span class="comment">// release resources of the derived class, and then calls</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">              <span class="comment">// Base::~Base() following the usual order of destruction</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>Moreover, if a class is polymorphic (declares or inherits at least one virtual function), and its destructor is not virtual, deleting it is undefined behavior regardless of whether there are resources that would be leaked if the derived destructor is not invoked.</p>
<h3 id="virtual-function-table"><a class="markdownIt-Anchor" href="#virtual-function-table"></a> virtual function table</h3>
<h4 id="what-do-vtables-have-to-do-with-all-this"><a class="markdownIt-Anchor" href="#what-do-vtables-have-to-do-with-all-this"></a> what do vtables have to do with all this?</h4>
<p>Well, there are cases where it is not possible for the compiler to know which routine to execute at compile time. This is the case, for instance, when we declare virtual functions:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="class">&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">bar</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">qux</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> B::bar()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"This is B's implementation of bar"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> B::qux()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"This is B's implementation of qux"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>The thing about virtual functions is that they can be overriden by subclasses:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> :</span> <span class="keyword">public</span> B</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">()</span> override</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> C::bar()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"This is C's implementation of bar"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>Now consider the following call to bar():</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">B* b = <span class="keyword">new</span> C();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">b-&gt;bar();</span></pre></td></tr></table></figure>
<p>If we use static dispatch as above, the call b-&gt;bar() would execute B::bar(), since (from the point of view of the compiler) b points to an object of type B. This would be horribly wrong, off course, because b actually points to an object of type C and C::bar() should be called instead.</p>
<p>Hopefully you can see the problem by now: given that virtual functions can be redefined in subclasses, calls via pointers (or references) to a base type can not be dispatched at compile time. The compiler has to find the right function definition (i.e. the most specific one) at runtime. This process is called dynamic dispatch or late method binding.</p>
<h4 id="how-do-we-implement-dynamic-dispatch"><a class="markdownIt-Anchor" href="#how-do-we-implement-dynamic-dispatch"></a> how do we implement dynamic dispatch?</h4>
<p>For every class that contains virtual functions, the compiler constructs a virtual table, a.k.a vtable. The vtable contains an entry for each virtual function accessible by the class and stores a pointer to its definition. Only the most specific function definition callable by the class is stored in the vtable. Entries in the vtable can point to either functions declared in the class itself (e.g. C::bar()), or virtual functions inherited from a base class (e.g. C::qux()).</p>
<p>In our example, the compiler will create the following virtual tables:<br>
<img alt="vtables" data-src="/assets/2019/12/09/vtables.png"></p>
<p>The vtable of class B has two entries, one for each of the two virtual functions declared in Bâ€™s scope: bar() and qux(). Additionally, the vtable of B points to the local definition of functions, since they are the most specific (and only) from Bâ€™s point of view.</p>
<p>More interesting is Câ€™s vtable. In this case, the entry for bar() points to own Câ€™s implementation, given that it is more specific than B::bar(). Since C doesnâ€™t override qux(), its entry in the vtable points to Bâ€™s definition (the most specific definition).</p>
<blockquote>
<p><strong>Note that vtables exist at the class level, meaning there exists a single vtable per class, and is shared by all instances.</strong></p>
</blockquote>
<h4 id="vpointers"><a class="markdownIt-Anchor" href="#vpointers"></a> Vpointers</h4>
<p>You might be thinking: vtables are cool and all, but how exactly do they solve the problem? When the compiler sees b-&gt;bar() in the example above, it will lookup Bâ€™s vtable for barâ€™s entry and follow the corresponding function pointer, right? We would still be calling B::bar() and not C::bar()â€¦</p>
<p>Very true, I still need to tell the second part of the story: vpointers. Every time the compiler creates a vtable for a class, it adds an extra argument to it: a pointer to the corresponding virtual table, called the vpointer.<br>
<img alt data-src="/assets/2019/12/09/vpointer.png"></p>
<p>Note that the vpointer is just another class member added by the compiler and increases the size of every object that has a vtable by sizeof(vpointer).</p>
<p>Hopefully you have grasped how dynamic function dispatch can be implemented by using vtables: when a call to a virtual function on an object is performed, the vpointer of the object is used to find the corresponding vtable of the class. Next, the function name is used as index to the vtable to find the correct (most specific) routine to be executed. Done!</p>
<h4 id="virtual-destructors"><a class="markdownIt-Anchor" href="#virtual-destructors"></a> Virtual Destructors</h4>
<p>By now it should also be clear why it is always a good idea to make destructors of base classes virtual. Since derived classes are often handled via base class references, declaring a non-virtual destructor will be dispatched statically, obfuscating the destructor of the derived class:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="class">&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  ~Base()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">  &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Destroying base"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Derived</span> :</span> <span class="keyword">public</span> Base</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">  Derived(<span class="keyword">int</span> number)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">  &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    some_resource_ = <span class="keyword">new</span> <span class="keyword">int</span>(number);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">  ~Derived()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">  &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Destroying derived"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">delete</span> some_resource_;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span>* some_resource_;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">  Base* p = <span class="keyword">new</span> Derived(<span class="number">5</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">delete</span> p;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>This will output:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Destroying base</span></pre></td></tr></table></figure>
<p>Making Baseâ€™s destructor virtual will result in the expected behavior:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Destroying derived</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">Destroying base</span></pre></td></tr></table></figure>
<h4 id="wrapping-up"><a class="markdownIt-Anchor" href="#wrapping-up"></a> Wrapping up</h4>
<blockquote>
<ol>
<li>Function overriding makes it impossible to dispatch virtual functions statically (at compile time)</li>
<li>Dispatching of virtual functions needs to happen at runtime</li>
<li>The virtual table method is a popular implementation of dynamic dispatch</li>
<li>For every class that defines or inherits virtual functions the compiler creates a virtual table</li>
<li>The virtual table stores a pointer to the most specific definition of each virtual function</li>
<li>For every class that has a vtable, the compiler adds an extra member to the class: the vpointer</li>
<li>The vpointer points to the corresponding vtable of the class</li>
<li>Always declare desctructors of base classes as virtual</li>
</ol>
</blockquote>
<h3 id="virtual-inherit"><a class="markdownIt-Anchor" href="#virtual-inherit"></a> Virtual inherit</h3>
<p>é€šè¿‡åˆç†çš„é‡æ„å’Œè®¾è®¡ï¼Œé¿å¼€ä½¿ç”¨è™šç»§æ‰¿</p>
<h3 id="æ‰©å±•é˜…è¯»"><a class="markdownIt-Anchor" href="#æ‰©å±•é˜…è¯»"></a> æ‰©å±•é˜…è¯»</h3>
<p>C++çš„ç¼–è¯‘å™¨åº”è¯¥æ˜¯ä¿è¯è™šå‡½æ•°è¡¨çš„æŒ‡é’ˆå­˜åœ¨äºå¯¹è±¡å®ä¾‹ä¸­æœ€å‰é¢çš„ä½ç½®ï¼ˆè¿™æ˜¯ä¸ºäº†ä¿è¯å–åˆ°è™šå‡½æ•°è¡¨çš„æœ‰æœ€é«˜çš„æ€§èƒ½â€”â€”å¦‚æœæœ‰å¤šå±‚ç»§æ‰¿æˆ–æ˜¯å¤šé‡ç»§æ‰¿çš„æƒ…å†µä¸‹ï¼‰ã€‚ è¿™æ„å‘³ç€æˆ‘ä»¬é€šè¿‡å¯¹è±¡å®ä¾‹çš„åœ°å€å¾—åˆ°è¿™å¼ è™šå‡½æ•°è¡¨ï¼Œç„¶åå°±å¯ä»¥éå†å…¶ä¸­å‡½æ•°æŒ‡é’ˆï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„å‡½æ•°ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">     <span class="keyword">public</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"Base::f"</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">g</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"Base::g"</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">h</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"Base::h"</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//Base b;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//sizeof (b); //outputs 8</span></span></pre></td></tr></table></figure>
<p>æŒ‰ç…§ä¸Šé¢çš„è¯´æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Baseçš„å®ä¾‹æ¥å¾—åˆ°è™šå‡½æ•°è¡¨ã€‚ ä¸‹é¢æ˜¯å®é™…ä¾‹ç¨‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(*Fun)</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">Base b;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">Fun pFun = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"è™šå‡½æ•°è¡¨åœ°å€ï¼š"</span> &lt;&lt; (<span class="keyword">int</span>*)(&amp;b) &lt;&lt; <span class="built_in">endl</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"è™šå‡½æ•°è¡¨ â€” ç¬¬ä¸€ä¸ªå‡½æ•°åœ°å€ï¼š"</span> &lt;&lt; (<span class="keyword">int</span>*)*(<span class="keyword">int</span>*)(&amp;b) &lt;&lt; <span class="built_in">endl</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// Invoke the first virtual function </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">pFun = (Fun)*((<span class="keyword">int</span>*)*(<span class="keyword">int</span>*)(&amp;b));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">pFun();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿è¡Œç»“æœ</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">è™šå‡½æ•°è¡¨åœ°å€ï¼š<span class="number">0x7ffdc351ecf0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">è™šå‡½æ•°è¡¨ â€” ç¬¬ä¸€ä¸ªå‡½æ•°åœ°å€ï¼š<span class="number">0x400e50</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">Base::f</span></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡å¼ºè¡ŒæŠŠ &amp;b è½¬æˆint*ï¼Œå–å¾—è™šå‡½æ•°è¡¨çš„åœ°å€ï¼Œç„¶åï¼Œå†æ¬¡å–å€å°±å¯ä»¥å¾—åˆ°ç¬¬ä¸€ä¸ªè™šå‡½æ•°çš„åœ°å€äº†ï¼Œä¹Ÿå°±æ˜¯Base::f()ï¼Œè¿™åœ¨ä¸Šé¢çš„ç¨‹åºä¸­å¾—åˆ°äº†éªŒè¯ï¼ˆæŠŠint* å¼ºåˆ¶è½¬æˆäº†å‡½æ•°æŒ‡é’ˆï¼‰ã€‚é€šè¿‡è¿™ä¸ªç¤ºä¾‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“å¦‚æœè¦è°ƒç”¨Base::g()å’ŒBase::h()</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">(Fun)*((<span class="keyword">int</span>*)*(<span class="keyword">int</span>*)(&amp;b)+<span class="number">0</span>);  <span class="comment">// Base::f()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">(Fun)*((<span class="keyword">int</span>*)*(<span class="keyword">int</span>*)(&amp;b)+<span class="number">1</span>);  <span class="comment">// Base::g()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">(Fun)*((<span class="keyword">int</span>*)*(<span class="keyword">int</span>*)(&amp;b)+<span class="number">2</span>);  <span class="comment">// Base::h()</span></span></pre></td></tr></table></figure>
<p><img alt="virtual table display" data-src="/assets/2019/12/09/vtable_exmple.png"></p>
<blockquote>
<p>ä¸Šå›¾ä¸­ï¼Œè™šå‡½æ•°è¡¨çš„æœ€åå¤šåŠ äº†ä¸€ä¸ªç»“ç‚¹ï¼Œè¿™æ˜¯è™šå‡½æ•°è¡¨çš„ç»“æŸç»“ç‚¹ï¼Œå°±åƒå­—ç¬¦ä¸²çš„ç»“æŸç¬¦â€œ/0â€ä¸€æ ·ï¼Œå…¶æ ‡å¿—äº†è™šå‡½æ•°è¡¨çš„ç»“æŸã€‚è¿™ä¸ªç»“æŸæ ‡å¿—çš„å€¼åœ¨ä¸åŒçš„ç¼–è¯‘å™¨ä¸‹æ˜¯ä¸åŒçš„ã€‚åœ¨WinXP+VS2003ä¸‹ï¼Œè¿™ä¸ªå€¼æ˜¯NULLã€‚è€Œåœ¨Ubuntu 7.10 + Linux 2.6.22 + GCC 4.1.3ä¸‹ï¼Œè¿™ä¸ªå€¼æ˜¯å¦‚æœ1ï¼Œè¡¨ç¤ºè¿˜æœ‰ä¸‹ä¸€ä¸ªè™šå‡½æ•°è¡¨ï¼Œå¦‚æœå€¼æ˜¯0ï¼Œè¡¨ç¤ºæ˜¯æœ€åä¸€ä¸ªè™šå‡½æ•°è¡¨ã€‚</p>
</blockquote>
<p>ä¸‹é¢å°†åˆ†åˆ«è¯´æ˜â€œæ— è¦†ç›–â€å’Œâ€œæœ‰è¦†ç›–â€æ—¶çš„è™šå‡½æ•°è¡¨çš„æ ·å­ã€‚æ²¡æœ‰è¦†ç›–çˆ¶ç±»çš„è™šå‡½æ•°æ˜¯æ¯«æ— æ„ä¹‰çš„ã€‚ä½œä¸ºå¯¹æ¯”ï¼Œå…ˆè¯´æ˜æ²¡æœ‰è¦†ç›–çš„æƒ…å†µã€‚åœ¨æ¯”è¾ƒä¹‹ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æ›´åŠ æ¸…æ¥šåœ°çŸ¥é“å…¶å†…éƒ¨çš„å…·ä½“å®ç°ã€‚</p>
<h4 id="ä¸€èˆ¬ç»§æ‰¿æ— è™šå‡½æ•°è¦†ç›–"><a class="markdownIt-Anchor" href="#ä¸€èˆ¬ç»§æ‰¿æ— è™šå‡½æ•°è¦†ç›–"></a> ä¸€èˆ¬ç»§æ‰¿ï¼ˆæ— è™šå‡½æ•°è¦†ç›–ï¼‰</h4>
<p>å‡è®¾æœ‰å¦‚ä¸‹æ‰€ç¤ºçš„ä¸€ä¸ªç»§æ‰¿å…³ç³»<br>
<img alt="inherit" data-src="/assets/2019/12/09/virtual_inherit_common.png"></p>
<p>æ³¨æ„ï¼Œåœ¨è¿™ä¸ªç»§æ‰¿å…³ç³»ä¸­ï¼Œå­ç±»æ²¡æœ‰é‡è½½ä»»ä½•çˆ¶ç±»çš„å‡½æ•°ã€‚é‚£ä¹ˆï¼Œåœ¨æ´¾ç”Ÿç±»çš„å®ä¾‹ä¸­ï¼Œ<br>
å¯¹äºå®ä¾‹ï¼šDerive d; çš„è™šå‡½æ•°è¡¨å¦‚ä¸‹ï¼š<br>
<img alt="vtable" data-src="/assets/2019/12/09/vtable_example2.png"></p>
<p>æ˜¾ç„¶å¯è§ï¼š</p>
<ol>
<li>è™šå‡½æ•°æŒ‰ç…§å…¶å£°æ˜é¡ºåºæ”¾äºè¡¨ä¸­ã€‚</li>
<li>çˆ¶ç±»çš„è™šå‡½æ•°åœ¨å­ç±»çš„è™šå‡½æ•°å‰é¢ã€‚</li>
</ol>
<h4 id="ä¸€èˆ¬ç»§æ‰¿æœ‰è™šå‡½æ•°è¦†ç›–"><a class="markdownIt-Anchor" href="#ä¸€èˆ¬ç»§æ‰¿æœ‰è™šå‡½æ•°è¦†ç›–"></a> ä¸€èˆ¬ç»§æ‰¿ï¼ˆæœ‰è™šå‡½æ•°è¦†ç›–ï¼‰</h4>
<p>å‡è®¾æœ‰å¦‚ä¸‹æ‰€ç¤ºçš„ä¸€ä¸ªç»§æ‰¿å…³ç³»<br>
<img alt="inherit" data-src="/assets/2019/12/09/virtual_inherit_common.png"></p>
<p>åœ¨è¿™ä¸ªç±»çš„è®¾è®¡ä¸­ï¼Œæˆ‘åªè¦†ç›–äº†çˆ¶ç±»çš„ä¸€ä¸ªå‡½æ•°ï¼šf()ã€‚é‚£ä¹ˆï¼Œå¯¹äºæ´¾ç”Ÿç±»çš„å®ä¾‹ï¼Œå…¶è™šå‡½æ•°è¡¨ä¼šæ˜¯ä¸‹é¢çš„ä¸€ä¸ªæ ·å­<br>
<img alt="vtable" data-src="/assets/2019/12/09/vtable_example3.png"></p>
<p>æˆ‘ä»¬ä»è¡¨ä¸­å¯ä»¥çœ‹åˆ°ä¸‹é¢å‡ ç‚¹ï¼Œ</p>
<ol>
<li>è¦†ç›–çš„f()å‡½æ•°è¢«æ”¾åˆ°äº†è™šè¡¨ä¸­åŸæ¥çˆ¶ç±»è™šå‡½æ•°çš„ä½ç½®ã€‚</li>
<li>æ²¡æœ‰è¢«è¦†ç›–çš„å‡½æ•°ä¾æ—§ã€‚</li>
</ol>
<p>ä¸‹é¢ç”±bæ‰€æŒ‡çš„å†…å­˜ä¸­çš„è™šå‡½æ•°è¡¨çš„f()çš„ä½ç½®å·²ç»è¢«Derive::f()å‡½æ•°åœ°å€æ‰€å–ä»£ï¼Œäºæ˜¯åœ¨å®é™…è°ƒç”¨å‘ç”Ÿæ—¶ï¼Œæ˜¯Derive::f()è¢«è°ƒç”¨äº†ã€‚è¿™å°±å®ç°äº†å¤šæ€ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Base *b = <span class="keyword">new</span> Derive();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">b-&gt;f();</span></pre></td></tr></table></figure>
<h4 id="å¤šé‡ç»§æ‰¿æ— è™šå‡½æ•°è¦†ç›–"><a class="markdownIt-Anchor" href="#å¤šé‡ç»§æ‰¿æ— è™šå‡½æ•°è¦†ç›–"></a> å¤šé‡ç»§æ‰¿ï¼ˆæ— è™šå‡½æ•°è¦†ç›–ï¼‰</h4>
<p>è®¾æœ‰ä¸‹é¢è¿™æ ·ä¸€ä¸ªç±»çš„ç»§æ‰¿å…³ç³»ã€‚æ³¨æ„ï¼šå­ç±»å¹¶æ²¡æœ‰è¦†ç›–çˆ¶ç±»çš„å‡½æ•°ã€‚<br>
<img alt="inherit" data-src="/assets/2019/12/09/virtual_inherit_multi.png"><br>
å­ç±»å®ä¾‹ä¸­çš„è™šå‡½æ•°è¡¨ï¼Œæ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š<br>
<img alt="vtable" data-src="/assets/2019/12/09/vtable_example4.png"></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š</p>
<ol>
<li>æ¯ä¸ªçˆ¶ç±»éƒ½æœ‰è‡ªå·±çš„è™šè¡¨ã€‚</li>
<li>å­ç±»çš„æˆå‘˜å‡½æ•°è¢«æ”¾åˆ°äº†ç¬¬ä¸€ä¸ªçˆ¶ç±»çš„è¡¨ä¸­ã€‚ï¼ˆæ‰€è°“çš„ç¬¬ä¸€ä¸ªçˆ¶ç±»æ˜¯æŒ‰ç…§å£°æ˜é¡ºåºæ¥åˆ¤æ–­çš„ï¼‰</li>
</ol>
<blockquote>
<p>è¿™æ ·åšå°±æ˜¯ä¸ºäº†è§£å†³ä¸åŒçš„çˆ¶ç±»ç±»å‹çš„æŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªå­ç±»å®ä¾‹ï¼Œè€Œèƒ½å¤Ÿè°ƒç”¨åˆ°å®é™…çš„å‡½æ•°ã€‚</p>
</blockquote>
<h4 id="å¤šé‡ç»§æ‰¿æœ‰è™šå‡½æ•°è¦†ç›–"><a class="markdownIt-Anchor" href="#å¤šé‡ç»§æ‰¿æœ‰è™šå‡½æ•°è¦†ç›–"></a> å¤šé‡ç»§æ‰¿ï¼ˆæœ‰è™šå‡½æ•°è¦†ç›–ï¼‰</h4>
<p>è®¾æœ‰ä¸‹é¢è¿™æ ·ä¸€ä¸ªç±»çš„ç»§æ‰¿å…³ç³»ã€‚ æ³¨æ„ï¼šæˆ‘ä»¬åœ¨å­ç±»ä¸­è¦†ç›–äº†çˆ¶ç±»çš„f()å‡½æ•°ã€‚<br>
<img alt="inherit" data-src="/assets/2019/12/09/virtual_inherit_multi.png"><br>
å­ç±»å®ä¾‹ä¸­çš„è™šå‡½æ•°è¡¨ï¼Œæ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š<br>
<img alt="vtable" data-src="/assets/2019/12/09/vtable_example5.png"></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹è§ï¼Œä¸‰ä¸ªçˆ¶ç±»è™šå‡½æ•°è¡¨ä¸­çš„f()çš„ä½ç½®è¢«æ›¿æ¢æˆäº†å­ç±»çš„å‡½æ•°æŒ‡é’ˆã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»»ä¸€é™æ€ç±»å‹çš„çˆ¶ç±»æ¥æŒ‡å‘å­ç±»ï¼Œå¹¶è°ƒç”¨å­ç±»çš„f()äº†ã€‚å¦‚ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Derive d;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">Base1 *b1 = &amp;d;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">Base2 *b2 = &amp;d;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">Base3 *b3 = &amp;d;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">b1-&gt;f(); <span class="comment">//Derive::f()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">b2-&gt;f(); <span class="comment">//Derive::f()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">b3-&gt;f(); <span class="comment">//Derive::f()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">b1-&gt;g(); <span class="comment">//Base1::g()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">b2-&gt;g(); <span class="comment">//Base2::g()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">b3-&gt;g(); <span class="comment">//Base3::g()</span></span></pre></td></tr></table></figure>
<h4 id="å®‰å…¨æ€§"><a class="markdownIt-Anchor" href="#å®‰å…¨æ€§"></a> å®‰å…¨æ€§</h4>
<h5 id="é€šè¿‡çˆ¶ç±»å‹çš„æŒ‡é’ˆè®¿é—®å­ç±»è‡ªå·±çš„è™šå‡½æ•°"><a class="markdownIt-Anchor" href="#é€šè¿‡çˆ¶ç±»å‹çš„æŒ‡é’ˆè®¿é—®å­ç±»è‡ªå·±çš„è™šå‡½æ•°"></a> é€šè¿‡çˆ¶ç±»å‹çš„æŒ‡é’ˆè®¿é—®å­ç±»è‡ªå·±çš„è™šå‡½æ•°</h5>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œå­ç±»æ²¡æœ‰é‡è½½çˆ¶ç±»çš„è™šå‡½æ•°æ˜¯ä¸€ä»¶æ¯«æ— æ„ä¹‰çš„äº‹æƒ…ã€‚å› ä¸ºå¤šæ€ä¹Ÿæ˜¯è¦åŸºäºå‡½æ•°é‡è½½çš„ã€‚è™½ç„¶åœ¨ä¸Šé¢çš„å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°Base1çš„è™šè¡¨ä¸­æœ‰Deriveçš„è™šå‡½æ•°ï¼Œä½†æˆ‘ä»¬æ ¹æœ¬ä¸å¯èƒ½ä½¿ç”¨ä¸‹é¢çš„è¯­å¥æ¥è°ƒç”¨å­ç±»çš„è‡ªæœ‰è™šå‡½æ•°ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Base1 *b1 = <span class="keyword">new</span> Derive();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">b1-&gt;f1();  <span class="comment">//ç¼–è¯‘å‡ºé”™</span></span></pre></td></tr></table></figure>
<p>ä»»ä½•å¦„å›¾ä½¿ç”¨çˆ¶ç±»æŒ‡é’ˆæƒ³è°ƒç”¨å­ç±»ä¸­çš„æœªè¦†ç›–çˆ¶ç±»çš„æˆå‘˜å‡½æ•°çš„è¡Œä¸ºéƒ½ä¼šè¢«ç¼–è¯‘å™¨è§†ä¸ºéæ³•ï¼Œæ‰€ä»¥ï¼Œè¿™æ ·çš„ç¨‹åºæ ¹æœ¬æ— æ³•ç¼–è¯‘é€šè¿‡ã€‚</p>
<blockquote>
<p><strong>ä½†åœ¨è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŒ‡é’ˆçš„æ–¹å¼è®¿é—®è™šå‡½æ•°è¡¨æ¥è¾¾åˆ°è¿åC++è¯­ä¹‰çš„è¡Œä¸ºã€‚</strong></p>
</blockquote>
<h5 id="è®¿é—®non-publicçš„è™šå‡½æ•°"><a class="markdownIt-Anchor" href="#è®¿é—®non-publicçš„è™šå‡½æ•°"></a> è®¿é—®non-publicçš„è™šå‡½æ•°</h5>
<p>å¦‚æœçˆ¶ç±»çš„è™šå‡½æ•°æ˜¯privateæˆ–æ˜¯protectedçš„ï¼Œä½†è¿™äº›épublicçš„è™šå‡½æ•°åŒæ ·ä¼šå­˜åœ¨äºè™šå‡½æ•°è¡¨ä¸­ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥ä½¿ç”¨è®¿é—®è™šå‡½æ•°è¡¨çš„æ–¹å¼æ¥è®¿é—®è¿™äº›non-publicçš„è™šå‡½æ•°ï¼Œè¿™æ˜¯å¾ˆå®¹æ˜“åšåˆ°çš„ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">private</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">	    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"Base::f"</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Derive</span> :</span> <span class="keyword">public</span> Base&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(*Fun)</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    Derive d;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    Fun  pFun = (Fun)*((<span class="keyword">int</span>*)*(<span class="keyword">int</span>*)(&amp;d)+<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    pFun();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<h5 id="é™„å½•å¤šé‡ç»§æ‰¿è¿è¡Œæ—¶ç¯å¢ƒçˆ¶ç±»å‹çš„æŒ‡é’ˆè®¿é—®å­ç±»è‡ªå·±çš„è™šå‡½æ•°"><a class="markdownIt-Anchor" href="#é™„å½•å¤šé‡ç»§æ‰¿è¿è¡Œæ—¶ç¯å¢ƒçˆ¶ç±»å‹çš„æŒ‡é’ˆè®¿é—®å­ç±»è‡ªå·±çš„è™šå‡½æ•°"></a> é™„å½•ï¼šå¤šé‡ç»§æ‰¿è¿è¡Œæ—¶ç¯å¢ƒçˆ¶ç±»å‹çš„æŒ‡é’ˆè®¿é—®å­ç±»è‡ªå·±çš„è™šå‡½æ•°</h5>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base1</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">      <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"Base1::f"</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">      <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">g</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"Base1::g"</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">      <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">h</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"Base1::h"</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base2</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">      <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"Base2::f"</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">      <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">g</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"Base2::g"</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">      <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">h</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"Base2::h"</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base3</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">      <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"Base3::f"</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">      <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">g</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"Base3::g"</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">      <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">h</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"Base3::h"</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Derive</span> :</span> <span class="keyword">public</span> Base1, <span class="keyword">public</span> Base2, <span class="keyword">public</span> Base3 &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">      <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"Derive::f"</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">      <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">g1</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"Derive::g1"</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(*Fun)</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">      Fun pFun = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">      Derive d;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">int</span>** pVtab = (<span class="keyword">int</span>**)&amp;d;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//Base1's vtable</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//pFun = (Fun)*((int*)*(int*)((int*)&amp;d+0)+0);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">      pFun = (Fun)pVtab[<span class="number">0</span>][<span class="number">0</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">      pFun();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//pFun = (Fun)*((int*)*(int*)((int*)&amp;d+0)+1);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">      pFun = (Fun)pVtab[<span class="number">0</span>][<span class="number">1</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">      pFun();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//pFun = (Fun)*((int*)*(int*)((int*)&amp;d+0)+2);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">      pFun = (Fun)pVtab[<span class="number">0</span>][<span class="number">2</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">      pFun();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//Derive's vtable</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//pFun = (Fun)*((int*)*(int*)((int*)&amp;d+0)+3);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">      pFun = (Fun)pVtab[<span class="number">0</span>][<span class="number">3</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">      pFun();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//The tail of the vtable</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">      pFun = (Fun)pVtab[<span class="number">0</span>][<span class="number">4</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">      <span class="built_in">cout</span>&lt;&lt;pFun&lt;&lt;<span class="built_in">endl</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//Base2's vtable</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//pFun = (Fun)*((int*)*(int*)((int*)&amp;d+1)+0);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">      pFun = (Fun)pVtab[<span class="number">1</span>][<span class="number">0</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line">      pFun();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//pFun = (Fun)*((int*)*(int*)((int*)&amp;d+1)+1);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line">      pFun = (Fun)pVtab[<span class="number">1</span>][<span class="number">1</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line">      pFun();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line">      pFun = (Fun)pVtab[<span class="number">1</span>][<span class="number">2</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line">      pFun(); </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//The tail of the vtable</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">77</span></pre></td><td class="code"><pre><span class="line">      pFun = (Fun)pVtab[<span class="number">1</span>][<span class="number">3</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">78</span></pre></td><td class="code"><pre><span class="line">      <span class="built_in">cout</span>&lt;&lt;pFun&lt;&lt;<span class="built_in">endl</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">79</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">80</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">81</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">82</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//Base3's vtable</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">83</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//pFun = (Fun)*((int*)*(int*)((int*)&amp;d+1)+0);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">84</span></pre></td><td class="code"><pre><span class="line">      pFun = (Fun)pVtab[<span class="number">2</span>][<span class="number">0</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">85</span></pre></td><td class="code"><pre><span class="line">      pFun();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">86</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">87</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//pFun = (Fun)*((int*)*(int*)((int*)&amp;d+1)+1);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">88</span></pre></td><td class="code"><pre><span class="line">      pFun = (Fun)pVtab[<span class="number">2</span>][<span class="number">1</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">89</span></pre></td><td class="code"><pre><span class="line">      pFun();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">90</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">91</span></pre></td><td class="code"><pre><span class="line">      pFun = (Fun)pVtab[<span class="number">2</span>][<span class="number">2</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">92</span></pre></td><td class="code"><pre><span class="line">      pFun(); </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">93</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">94</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//The tail of the vtable</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">95</span></pre></td><td class="code"><pre><span class="line">      pFun = (Fun)pVtab[<span class="number">2</span>][<span class="number">3</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">96</span></pre></td><td class="code"><pre><span class="line">      <span class="built_in">cout</span>&lt;&lt;pFun&lt;&lt;<span class="built_in">endl</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">97</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">98</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">99</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<h3 id="reference"><a class="markdownIt-Anchor" href="#reference"></a> @Reference</h3>
<ul>
<li><a href="https://en.cppreference.com/w/cpp/language/virtual" target="_blank" rel="noopener">virtual official manual</a></li>
<li><a href="https://stackoverflow.com/questions/2391679/why-do-we-need-virtual-functions-in-c" target="_blank" rel="noopener">why-do-we-need-virtual-functions</a></li>
<li><a href="https://pabloariasal.github.io/2017/06/10/understanding-virtual-tables/" target="_blank" rel="noopener">understanding-virtual-tables</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/C/" rel="tag"><i class="fa fa-tag"></i> C++</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/program/C++11-Features-Overview.html" rel="prev" title="C++11 Features Overview(C++11æ–°ç‰¹æ€§æŒ‡å—)">
      <i class="fa fa-chevron-left"></i> C++11 Features Overview(C++11æ–°ç‰¹æ€§æŒ‡å—)
    </a></div>
      <div class="post-nav-item">
    <a href="/program/C++-Operator-Overload.html" rel="next" title="C++ Operator Overload(èµ‹å€¼è¿ç®—ç¬¦é‡è½½)">
      C++ Operator Overload(èµ‹å€¼è¿ç®—ç¬¦é‡è½½) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#c-virtual"><span class="nav-number">1.</span> <span class="nav-text"> C++ Virtual</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#virtual-function"><span class="nav-number">1.1.</span> <span class="nav-text"> Virtual Function</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#whats-virtual"><span class="nav-number">1.1.1.</span> <span class="nav-text"> whatâ€™s virtual</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#explanation"><span class="nav-number">1.1.2.</span> <span class="nav-text"> Explanation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#another-example-why-virtual-required"><span class="nav-number">1.1.3.</span> <span class="nav-text"> another example (why virtual required)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#in-detail"><span class="nav-number">1.2.</span> <span class="nav-text"> In detail</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#æ€»ç»“"><span class="nav-number">1.2.1.</span> <span class="nav-text"> æ€»ç»“ï¼š</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#covariant-return-types"><span class="nav-number">1.3.</span> <span class="nav-text"> Covariant return types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#virtual-destructor"><span class="nav-number">1.4.</span> <span class="nav-text"> Virtual destructor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#virtual-function-table"><span class="nav-number">1.5.</span> <span class="nav-text"> virtual function table</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#what-do-vtables-have-to-do-with-all-this"><span class="nav-number">1.5.1.</span> <span class="nav-text"> what do vtables have to do with all this?</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#how-do-we-implement-dynamic-dispatch"><span class="nav-number">1.5.2.</span> <span class="nav-text"> how do we implement dynamic dispatch?</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#vpointers"><span class="nav-number">1.5.3.</span> <span class="nav-text"> Vpointers</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#virtual-destructors"><span class="nav-number">1.5.4.</span> <span class="nav-text"> Virtual Destructors</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#wrapping-up"><span class="nav-number">1.5.5.</span> <span class="nav-text"> Wrapping up</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#virtual-inherit"><span class="nav-number">1.6.</span> <span class="nav-text"> Virtual inherit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ‰©å±•é˜…è¯»"><span class="nav-number">1.7.</span> <span class="nav-text"> æ‰©å±•é˜…è¯»</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ä¸€èˆ¬ç»§æ‰¿æ— è™šå‡½æ•°è¦†ç›–"><span class="nav-number">1.7.1.</span> <span class="nav-text"> ä¸€èˆ¬ç»§æ‰¿ï¼ˆæ— è™šå‡½æ•°è¦†ç›–ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ä¸€èˆ¬ç»§æ‰¿æœ‰è™šå‡½æ•°è¦†ç›–"><span class="nav-number">1.7.2.</span> <span class="nav-text"> ä¸€èˆ¬ç»§æ‰¿ï¼ˆæœ‰è™šå‡½æ•°è¦†ç›–ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#å¤šé‡ç»§æ‰¿æ— è™šå‡½æ•°è¦†ç›–"><span class="nav-number">1.7.3.</span> <span class="nav-text"> å¤šé‡ç»§æ‰¿ï¼ˆæ— è™šå‡½æ•°è¦†ç›–ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#å¤šé‡ç»§æ‰¿æœ‰è™šå‡½æ•°è¦†ç›–"><span class="nav-number">1.7.4.</span> <span class="nav-text"> å¤šé‡ç»§æ‰¿ï¼ˆæœ‰è™šå‡½æ•°è¦†ç›–ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#å®‰å…¨æ€§"><span class="nav-number">1.7.5.</span> <span class="nav-text"> å®‰å…¨æ€§</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#é€šè¿‡çˆ¶ç±»å‹çš„æŒ‡é’ˆè®¿é—®å­ç±»è‡ªå·±çš„è™šå‡½æ•°"><span class="nav-number">1.7.5.1.</span> <span class="nav-text"> é€šè¿‡çˆ¶ç±»å‹çš„æŒ‡é’ˆè®¿é—®å­ç±»è‡ªå·±çš„è™šå‡½æ•°</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#è®¿é—®non-publicçš„è™šå‡½æ•°"><span class="nav-number">1.7.5.2.</span> <span class="nav-text"> è®¿é—®non-publicçš„è™šå‡½æ•°</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#é™„å½•å¤šé‡ç»§æ‰¿è¿è¡Œæ—¶ç¯å¢ƒçˆ¶ç±»å‹çš„æŒ‡é’ˆè®¿é—®å­ç±»è‡ªå·±çš„è™šå‡½æ•°"><span class="nav-number">1.7.5.3.</span> <span class="nav-text"> é™„å½•ï¼šå¤šé‡ç»§æ‰¿è¿è¡Œæ—¶ç¯å¢ƒçˆ¶ç±»å‹çš„æŒ‡é’ˆè®¿é—®å­ç±»è‡ªå·±çš„è™šå‡½æ•°</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reference"><span class="nav-number">1.8.</span> <span class="nav-text"> @Reference</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Fayhot"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Fayhot</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/fayhot" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;fayhot" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:liuguoqing228@gmail.com" title="E-Mail â†’ mailto:liuguoqing228@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/shisanyaowan" title="Weibo â†’ https:&#x2F;&#x2F;weibo.com&#x2F;shisanyaowan" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Fayhot</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme â€“ <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.5.0
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
